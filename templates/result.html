{% extends 'admin_base.html' %}
{% block title %}Upload Results{% endblock %}

{% block content %}
<div class="container-fluid">
  <h2 class="mb-4">Post Upload Results</h2>

  <div class="card shadow-sm rounded">
    <div class="card-body">
      <div class="table-responsive">
        {% if posts %}
        <table class="table table-hover table-striped">
          <thead>
            <tr>
              <th>Title</th>
              <th>Summary</th>
              <th>Image</th>
              <th>Created At</th>
              <th>Content</th>
            </tr>
          </thead>
          <tbody>
            {% for post in posts %}
            <tr>
              <td>{{ post.title }}</td>
              <td>{{ post.summary }}</td>
              <td>
                {% if post.image_url %}
                <img
                  src="{{ post.image_url }}"
                  alt="Post Image"
                  class="img-fluid rounded"
                  style="max-width: 100px; max-height: 100px; object-fit: cover;"
                />
                {% else %} No Image {% endif %}
              </td>
              <td>{{ post.created_at }}</td>
              <td>
                {% set truncated_content = post.content | striptags | truncate(150, True, '...') %}
                {{ truncated_content | safe }}
                {% if post.content | length > 150 %}
                <button
                  type="button"
                  class="btn btn-link btn-sm p-0"
                  data-bs-toggle="modal"
                  data-bs-target="#contentModal"
                  data-title="{{ post.title }}"
                  data-content="{{ post.content | e }}"
                >
                  Read More
                </button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="text-center text-muted">No posts found or processed.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Content Modal -->
<div
  class="modal fade"
  id="contentModal"
  tabindex="-1"
  aria-labelledby="contentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content rounded">
      <div class="modal-header bg-primary text-white rounded-top">
        <h5 class="modal-title" id="contentModalLabel">Post Content</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <h6 id="modalTitle" class="mb-3"></h6>
        <div id="modalContent" class="bg-light p-3 rounded" style="white-space: pre-wrap;"></div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-primary rounded me-auto"
          id="copyContentBtn"
        >
          Copy to Clipboard
        </button>
        <button
          type="button"
          class="btn btn-secondary rounded"
          data-bs-dismiss="modal"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function () {
    // Show full content in modal
    $("#contentModal").on("show.bs.modal", function (event) {
      const button = $(event.relatedTarget);
      const title = button.data("title");
      const content = button.data("content");

      const modal = $(this);
      modal.find("#modalTitle").text(title);
      modal.find("#modalContent").html(content);
    });

    // Copy to clipboard using Clipboard API
 $("#copyContentBtn").click(function () {
  const content = document.getElementById("modalContent").innerText;
  const fallbackCopy = () => {
    const textarea = document.createElement("textarea");
    textarea.value = content;
    textarea.style.position = "fixed"; // Prevent scrolling to bottom
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    try {
      const successful = document.execCommand("copy");
      const msg = successful ? "Copied!" : "Copy failed";
      $(this).text(msg);
      setTimeout(() => $(this).text("Copy to Clipboard"), 1500);
    } catch (err) {
      alert("Fallback copy failed: " + err);
    }
    document.body.removeChild(textarea);
  };

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(content)
      .then(() => {
        const originalText = $(this).text();
        $(this).text("Copied!");
        setTimeout(() => {
          $(this).text(originalText);
        }, 1500);
      })
      .catch(() => fallbackCopy());
  } else {
    fallbackCopy();
  }
});
  });
</script>
{% endblock %}
